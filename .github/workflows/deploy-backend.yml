name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "scripts/deploy_backend_cloud_run.sh"
      - "scripts/configure_cloud_scheduler.sh"
      - "scripts/smoke_backend_post_deploy.sh"
      - "pyproject.toml"
      - "uv.lock"
      - "config.yaml"
      - ".github/workflows/deploy-backend.yml"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      GCP_REGION: ${{ secrets.GCP_REGION }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_SECRET_KEY }}
      SUPABASE_JWT_SECRET: ${{ secrets.SUPABASE_JWT_SECRET }}
      CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
      PIPELINE_TRIGGER_TOKEN: ${{ secrets.PIPELINE_TRIGGER_TOKEN }}
      SERVICE_NAME: curately-backend
      ENABLE_REQUIRED_APIS: "false"
      BUILD_STRATEGY: "local"
      IMAGE_TAGS: sha-${{ github.sha }},latest
    steps:
      - uses: actions/checkout@v6

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v3

      - name: Deploy Cloud Run backend
        run: ./scripts/deploy_backend_cloud_run.sh

      - name: Resolve backend URL
        id: backend_url
        run: |
          BACKEND_URL="$(gcloud run services describe "${SERVICE_NAME}" \
            --region "${GCP_REGION}" \
            --project "${GCP_PROJECT}" \
            --format 'value(status.url)')"
          echo "url=${BACKEND_URL}" >> "$GITHUB_OUTPUT"

      - name: Run backend post-deploy smoke test
        env:
          BACKEND_URL: ${{ steps.backend_url.outputs.url }}
        run: ./scripts/smoke_backend_post_deploy.sh

      - name: Configure Cloud Scheduler jobs
        run: |
          BACKEND_URL="${{ steps.backend_url.outputs.url }}"
          export BACKEND_URL
          ./scripts/configure_cloud_scheduler.sh
